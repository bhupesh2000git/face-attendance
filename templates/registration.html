<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Registration</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      #videoFeed {
        width: 100%;
        max-width: 640px;
        border: 2px solid #000;
      }
      #registrationForm {
        max-width: 640px;
        margin-top: 10px;
      }
    </style>
  </head>
  <body>
    <div class="container mt-5">
      <h1>Register New Face</h1>
      <div class="mt-4">
        <video
          id="videoFeed"
          autoplay
          playsinline
          style="display: none"
        ></video>
        <p
          id="permissionMessage"
          class="alert alert-info"
          style="display: none"
        >
          Please allow camera access.
        </p>
        <div id="message" class="mt-3"></div>
      </div>
      <form id="registrationForm" class="mt-4">
        <div class="mb-3">
          <label for="name" class="form-label">name</label>
          <input
            type="text"
            class="form-control"
            id="name"
            name="name"
            required
          />
        </div>
        <button type="submit" class="btn btn-primary" id="saveButton">
          Save
        </button>
        <a href="/" class="btn btn-secondary">Back</a>
      </form>
    </div>
    <script>
      window.onload = async () => {
        const videoFeed = document.getElementById("videoFeed");
        const permissionMessage = document.getElementById("permissionMessage");
        const messageDiv = document.getElementById("message");
        const saveButton = document.getElementById("saveButton");

        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            video: { width: 640, height: 480 },
          });
          permissionMessage.style.display = "none";
          videoFeed.srcObject = stream;
          videoFeed.style.display = "block";
          videoFeed.play();
        } catch (err) {
          messageDiv.innerHTML =
            '<div class="alert alert-danger">Camera not accessible. Check settings or hardware. Error: ' +
            err.message +
            "</div>";
          console.error("Camera error:", err);
        }

        document
          .getElementById("registrationForm")
          .addEventListener("submit", async (e) => {
            e.preventDefault();
            const name = document.getElementById("name").value.trim();
            const messageDiv = document.getElementById("message");

            if (!name) {
              messageDiv.innerHTML =
                '<div class="alert alert-danger">Please enter a name.</div>';
              return;
            }

            saveButton.disabled = true; // Disable button to prevent multiple clicks
            messageDiv.innerHTML =
              '<div class="alert alert-info">Saving...</div>';

            const canvas = document.createElement("canvas");
            canvas.width = videoFeed.videoWidth || 640;
            canvas.height = videoFeed.videoHeight || 480;
            const context = canvas.getContext("2d");
            context.drawImage(videoFeed, 0, 0, canvas.width, canvas.height);
            const imageData = canvas.toDataURL("image/jpeg").split(",")[1];

            try {
              const response = await fetch("/save_face", {
                method: "POST",
                headers: {
                  "Content-Type": "application/x-www-form-urlencoded",
                },
                body: `name=${encodeURIComponent(
                  name
                )}&image=${encodeURIComponent(imageData)}`,
              });

              const result = await response.json();
              messageDiv.innerHTML = `<div class="alert alert-${
                result.success ? "success" : "danger"
              }">${result.message}</div>`;
              if (result.success) {
                if (videoFeed.srcObject)
                  videoFeed.srcObject
                    .getTracks()
                    .forEach((track) => track.stop());
                setTimeout(() => {
                  window.location.href = "/";
                }, 1000); // Redirect after 1 second
              } else {
                saveButton.disabled = false; // Re-enable button if failed
              }
            } catch (error) {
              messageDiv.innerHTML =
                '<div class="alert alert-danger">Failed to save. Check server or network. Error: ' +
                error.message +
                "</div>";
              saveButton.disabled = false; // Re-enable button if error
              console.error("Fetch error:", error);
            }
          });
      };
    </script>
  </body>
</html>
